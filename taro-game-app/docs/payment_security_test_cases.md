# 游戏支付系统渗透测试用例

## 1. 订单金额篡改攻击测试

### 1.1 测试目标
验证支付系统是否能够防止客户端篡改订单金额，确保交易金额的完整性和一致性。

### 1.2 风险等级
**高风险** - 可能导致直接经济损失

### 1.3 前置条件
- 已安装网络代理工具（如Charles、Burp Suite等）
- 已配置SSL证书以解密HTTPS流量
- 已获取测试账号和测试环境访问权限

### 1.4 测试步骤

#### 1.4.1 客户端请求拦截测试
1. 启动网络代理工具，配置移动设备通过代理访问网络
2. 在游戏中选择商品并进入支付流程
3. 拦截`createOrder`请求，修改请求体中的`amount`参数（例如：将1000分改为1分）
4. 放行修改后的请求，观察系统响应
5. 完成支付流程，检查订单状态和实际扣款金额

#### 1.4.2 签名绕过测试
1. 拦截`createOrder`请求
2. 修改请求中的`amount`参数
3. 尝试以下方法绕过签名验证：
   - 保持原签名不变
   - 移除签名参数
   - 使用历史有效签名
   - 修改时间戳参数延长签名有效期
4. 放行请求，观察系统响应

#### 1.4.3 中间人攻击模拟
1. 配置代理工具作为中间人
2. 在支付过程中拦截并修改服务器返回的支付参数
3. 尝试修改`totalFee`或等价参数
4. 完成支付流程，验证实际扣款金额

### 1.5 预期结果
- 系统应拒绝处理被篡改的订单请求
- 服务端应验证订单金额与初始创建金额是否一致
- 支付完成后应进行二次验证，确认实际支付金额

### 1.6 缓解措施
1. 实现服务端订单金额二次校验机制
2. 使用不可预测的签名算法，包含订单关键信息
3. 实现请求防重放机制（nonce + 时间戳）
4. 对异常订单金额变更进行告警
5. 在订单创建时锁定价格，支付时进行比对

## 2. 虚假支付回调注入测试

### 2.1 测试目标
验证系统是否能够有效防止伪造的支付成功通知，确保只有合法的支付才能获得游戏内资源。

### 2.2 风险等级
**高风险** - 可能导致未授权资源获取和经济损失

### 2.3 前置条件
- 了解支付回调接口的URL结构和参数格式
- 具备HTTP请求构造工具（如Postman、curl等）
- 已获取测试账号和测试环境访问权限

### 2.4 测试步骤

#### 2.4.1 回调参数伪造测试
1. 创建正常订单但不完成支付
2. 使用HTTP工具构造支付回调请求，模拟支付成功通知
3. 在请求中包含以下参数：
   - 订单ID（使用刚创建的订单）
   - 支付状态（设置为成功）
   - 支付金额（与订单金额一致）
   - 支付时间（当前时间）
   - 交易流水号（随机生成）
4. 发送伪造的回调请求到支付通知接口
5. 观察系统响应和订单状态变化

#### 2.4.2 签名绕过测试
1. 分析回调接口的签名验证机制
2. 尝试以下方法绕过签名验证：
   - 使用空签名
   - 使用历史有效签名
   - 尝试签名算法弱点（如哈希长度扩展攻击）
3. 发送构造的回调请求，观察系统响应

#### 2.4.3 重放攻击测试
1. 捕获一个有效的支付成功回调请求
2. 等待一段时间后重新发送该请求
3. 观察系统是否重复处理该回调
4. 测试不同的时间间隔（1分钟、10分钟、1小时、1天）

### 2.5 预期结果
- 系统应拒绝处理未经有效签名验证的回调请求
- 系统应防止重复处理相同的支付通知
- 系统应验证回调中的订单信息与数据库记录一致

### 2.6 缓解措施
1. 实现严格的回调签名验证机制
2. 使用nonce和时间戳防止重放攻击
3. 实现幂等性处理，防止重复处理相同支付通知
4. 建立支付状态机制，防止非法状态转换
5. 对可疑的支付回调请求进行日志记录和告警

## 3. 用户资产溢出漏洞测试

### 3.1 测试目标
验证系统在处理用户资产（如游戏币、道具等）时是否存在整数溢出漏洞，确保资产计算的准确性和安全性。

### 3.2 风险等级
**高风险** - 可能导致游戏经济系统崩溃和直接经济损失

### 3.3 前置条件
- 已获取测试账号和测试环境访问权限
- 了解游戏内资产的存储和计算机制
- 具备网络代理工具和API测试工具

### 3.4 测试步骤

#### 3.4.1 整数溢出测试
1. 分析游戏中资产的数据类型和边界值
2. 尝试通过以下方式触发整数溢出：
   - 执行大量小额充值，累积接近最大值
   - 在资产接近最大值时再次充值
   - 利用负数金额的充值或消费请求
3. 观察系统处理结果和资产变化

#### 3.4.2 并发交易测试
1. 准备多个并发请求，同时对同一账户进行充值或消费操作
2. 使用多线程工具发送这些请求
3. 验证最终账户余额是否正确
4. 检查交易历史记录的完整性

#### 3.4.3 边界值测试
1. 尝试以下边界值操作：
   - 最大可能金额的充值
   - 接近最大值时的多次小额充值
   - 0金额或负数金额的交易
   - 极小金额（如0.01）的多次交易
2. 观察系统响应和资产计算结果

### 3.5 预期结果
- 系统应正确处理各种金额的交易，不出现溢出错误
- 系统应拒绝处理负数金额的交易
- 并发交易应保持数据一致性，不出现资产计算错误
- 系统应对接近边界值的操作有合理的限制和处理

### 3.6 缓解措施
1. 使用适当的数据类型存储资产金额（如使用BigDecimal而非int/float）
2. 实现资产操作的边界检查
3. 对所有资产变更操作进行事务管理
4. 实现并发控制机制，如乐观锁或悲观锁
5. 定期对账，确保用户资产与交易历史一致
6. 对异常的资产变动进行监控和告警

## 4. 综合安全建议

### 4.1 架构层面
1. 实现完整的支付流程日志记录，便于审计和追踪
2. 建立支付风控系统，对异常交易进行实时监控
3. 实现多层次的安全验证机制，不依赖单点防护
4. 定期进行支付系统的安全评估和渗透测试

### 4.2 开发实践
1. 遵循安全编码规范，防止常见的安全漏洞
2. 对所有用户输入进行严格验证和过滤
3. 使用参数化查询防止SQL注入
4. 实现适当的错误处理，避免泄露敏感信息

### 4.3 运维措施
1. 定期更新密钥和证书
2. 实施最小权限原则
3. 对支付系统进行实时监控
4. 建立完善的应急响应机制

## 5. 测试结果记录模板

| 测试用例ID | 测试日期 | 测试环境 | 测试结果 | 发现问题 | 修复状态 |
|-----------|---------|---------|---------|---------|--------|
| PT-001    |         |         |         |         |        |
| PT-002    |         |         |         |         |        |
| PT-003    |         |         |         |         |        |

## 6. 责任声明

本测试用例文档仅用于安全测试目的，禁止将其用于任何非法活动。所有测试必须在授权的测试环境中进行，并遵循相关法律法规和道德准则。未经授权，不得对生产环境执行任何渗透测试操作。